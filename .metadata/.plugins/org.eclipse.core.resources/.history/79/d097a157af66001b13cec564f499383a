<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<body>

	<h1>Chat Application</h1>

	<form action="">
		<table>
			<tr>
				<td>All Messages<br /> <textarea rows="15" cols="40"
						id="allMessage" readonly="readonly"></textarea></td>
				<td>Sensors<br /> <textarea readonly="readonly" rows="16"
						cols="15" id="sensors"></textarea>
				</td>
			</tr>
			<tr>
				<td colspan="2"><input id="txtMessage" size="70" type="text" />
					<input onclick="sendMessage();" value="SendMessage" type="button" />
					<input onclick="disconnect();" value="Disconnect" type="button" />
				</td>
			</tr>
		</table>
	</form>
	<div id="output"></div>

	<script>
		var ws = new WebSocket("ws://localhost:8080/ChatApplication/messagingendpoint");
		var txtMessage = document.getElementById("txtMessage");
		var allMessage = document.getElementById("allMessage");
		var sensor = document.getElementById("sensors");

		var output = document.getElementById("output");
		ws.onopen = function(evt) {
			onOpen(evt);
		};
		ws.onmessage = function(evt) {
			onMessage(evt);
		};
		ws.onerror = function(evt) {
			onError(evt);
		};
		ws.onclose = function(evt) {
			onClose(evt);
		};
		function extractUserName(message){
			userName = message.substring(
					message.indexOf(">") + 1, message.length - 2);
			return userName;
		}
		
		function onMessage(evt) {
			console.log('evt.data', evt.data);
			var jsdata = JSON.parse(evt.data);
			if(Array.isArray(jsdata)){
				console.log('evt.data is an array', jsdata);
				var sensorname = extractUserName(jsdata[0]);
				sensor.innerHTML += sensorname;
				
				
			} 
			else if (jsdata.message != null) {
				if (evt.data.indexOf(">") !== -1) {
					var sensorname = extractUserName(evt.data);
					sensor.innerHTML += sensorname;
				} else

					allMessage.value += jsdata.message + "\n";
				writeToScreen("RECEIVED: " + evt.data);
			}
		}

		function sendMessage() {
			ws.send(txtMessage.value);
			txtMessage.value = "";
		}
		function onOpen() {
			writeToScreen("CONNECTED");
		}
		function onClose() {
			writeToScreen("DISCONNECTED");
		}
		function onError(evt) {
			writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
		}
		function writeToScreen(message) {
			var pre = document.createElement("p");
			pre.style.wordWrap = "break-word";
			pre.innerHTML = message;
			output.appendChild(pre);
		}
		function disconnect() {
			ws.close();
		}
	</script>
</body>
</html>
