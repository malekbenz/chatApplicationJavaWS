<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<body>

	<h1>Chat Application</h1>

	<form action="">
		<table>
			<tr>
				<td>All Messages<br /> <textarea rows="15" cols="40"
						id="txtAllMessage" readonly="readonly"></textarea></td>
				<td>Sensors<br /> <textarea readonly="readonly" rows="16"
						cols="15" id="sensors"></textarea>
				</td>
			</tr>
			<tr>
				<td colspan="2"><input id="txtMessage" size="70" type="text" />
					<input onclick="sendMessage();" value="SendMessage" type="button" />
					<input onclick="disconnect();" value="Disconnect" type="button" />
				</td>
			</tr>
		</table>
	</form>
	<div id="output"></div>

	<script>
		var URL = "ws://localhost:8080/ChatApplication/messages";
		var output = document.getElementById("output");
		var txtMessage = document.getElementById("txtMessage");
		var txtAllMessage = document.getElementById("txtAllMessage");
		var sensor = document.getElementById("sensors");

		var ws = null;
		var isConnected = ()=> ws.readyState == 1;
		
		function connect() {
			ws = new WebSocket(URL);

			ws.onopen = function(evt) {
				writeToScreen("CONNECTED");
				console.log('isConnected', isConnected() )
			};

			ws.onmessage = function(evt) {
				console.log('evt.data', evt.data);
				var jsdata = JSON.parse(evt.data);
				if (Array.isArray(jsdata)) {
					console.log('evt.data is an array', jsdata);
					sensor.innerHTML += extractUserName(jsdata[0]);
					writeToScreen("RECEIVED: " + jsdata[0]);
					for (var i = 1; i < jsdata.length; i++) {
						var msg = JSON.parse(jsdata[i]);
						showMessage(msg.message);

					}

				} else {
					showMessage(jsdata.message);
					writeToScreen("RECEIVED: " + jsdata.message);

				}
			};
			
			ws.onerror = function(evt) {
				writeToScreen('<span style="color: red;">ERROR:</span> '
						+ evt.data);
			};

			ws.onclose = function(evt) {
				writeToScreen("DISCONNECTED");
			};
		}

		connect();

		function extractUserName(message) {
			userName = message.substring(message.indexOf(">") + 1,
					message.length - 2);
			return userName;
		}

		function showMessage(message) {
			txtAllMessage.value += message + "\n";

		}

			
		function sendMessageToServer() {
			ws.send(txtMessage.value);
			txtMessage.value = "";
		}
		
		function sendMessage() {
			
			if(!isConnected()){
				connect();
				setTimeout( sendMessageToServer,10)
				
			}else{
				sendMessageToServer()
			}
		}

		function writeToScreen(message) {
			var pre = document.createElement("p");
			pre.style.wordWrap = "break-word";
			pre.innerHTML = message;
			output.appendChild(pre);
		}

		function disconnect() {
			ws.close();
		}
	</script>
</body>
</html>
